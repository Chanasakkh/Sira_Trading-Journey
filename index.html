<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journey</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        /* ... (CSS เดิมของคุณทั้งหมด เก็บไว้เหมือนเดิม) ... */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --border-color: #2a2a2a;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-gold: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Instrument Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03; pointer-events: none; z-index: 1000;
        }

        .container { max-width: 1800px; margin: 0 auto; padding: 40px 20px; }

        /* Header Styles Modified for new button */
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 60px; padding-bottom: 40px; border-bottom: 1px solid var(--border-color); }
        .logo-section h1 { font-family: 'Space Mono', monospace; font-size: 2.5rem; font-weight: 700; letter-spacing: -2px; margin-bottom: 8px; }
        .logo-section h1 span { color: var(--text-muted); }
        .logo-section p { font-size: 0.875rem; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        
        .upload-section { display: flex; flex-direction: row; align-items: center; gap: 12px; flex-wrap: wrap; }
        
        .btn { background: var(--text-primary); color: var(--bg-primary); border: none; padding: 14px 28px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: 'Instrument Sans', sans-serif; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .btn:hover { background: var(--text-secondary); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { border-color: var(--text-primary); background: rgba(255,255,255,0.05); }

        .file-input { display: none; }
        .file-name { font-size: 0.75rem; color: var(--text-muted); font-family: 'Space Mono', monospace; margin-top: 8px; width: 100%; text-align: right; }

        /* ... (Paste CSS เดิมของคุณต่อจากตรงนี้ได้เลย ผมละไว้เพื่อความกระชับ) ... */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border-color); margin-bottom: 60px; opacity: 0; transform: translateY(20px); transition: all 0.6s ease; }
        .stats-grid.loaded { opacity: 1; transform: translateY(0); }
        .stat-card { background: var(--bg-secondary); padding: 32px; display: flex; flex-direction: column; gap: 8px; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; font-family: 'Space Mono', monospace; }
        .stat-value { font-size: 2.5rem; font-weight: 700; font-family: 'Space Mono', monospace; letter-spacing: -2px; }
        .stat-value.positive { color: var(--accent-green); }
        .stat-value.negative { color: var(--accent-red); }
        .stat-sub { font-size: 0.875rem; color: var(--text-secondary); }

        /* Performance Section */
        .performance-section { display: grid; grid-template-columns: 1fr 1fr 280px; gap: 1px; background: var(--border-color); margin-bottom: 40px; opacity: 0; transform: translateY(20px); transition: all 0.6s ease; }
        .performance-section.loaded { opacity: 1; transform: translateY(0); }
        .chart-container { background: var(--bg-secondary); padding: 24px; }
        .extended-stats { background: var(--bg-secondary); padding: 24px; }
        .section-title { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; }
        .chart-wrapper { height: 200px; position: relative; }
        .stats-list { display: flex; flex-direction: column; gap: 14px; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; }
        .stats-label { font-size: 0.85rem; color: var(--text-secondary); }
        .stats-value { font-family: 'Space Mono', monospace; font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
        .stats-value.positive { color: var(--accent-green); }
        .stats-value.negative { color: var(--accent-red); }

        /* Calendar Section */
        .calendar-section { background: var(--bg-secondary); border: 1px solid var(--border-color); margin-bottom: 40px; opacity: 0; transform: translateY(20px); transition: all 0.6s ease; display: grid; grid-template-columns: 1fr 300px; }
        .calendar-section.loaded { opacity: 1; transform: translateY(0); }
        .calendar-main { padding: 24px; border-right: 1px solid var(--border-color); }
        .calendar-sidebar { background: var(--bg-tertiary); padding: 24px; display: flex; flex-direction: column; justify-content: center; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .calendar-title { font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700; text-transform: uppercase; }
        .calendar-nav { display: flex; gap: 8px; }
        .calendar-nav-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .calendar-nav-btn:hover { border-color: var(--text-primary); color: var(--text-primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr) 80px; gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); }
        .calendar-day-header { background: var(--bg-tertiary); padding: 12px 4px; text-align: center; font-size: 0.7rem; color: var(--text-muted); font-family: 'Space Mono', monospace; text-transform: uppercase; }
        .calendar-day-header.weekly-sum { color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); font-weight: 700; }
        .calendar-day { background: var(--bg-secondary); min-height: 100px; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; transition: background 0.2s; position: relative; }
        .calendar-day:hover { background: var(--bg-tertiary); }
        .calendar-day.empty { background: rgba(17, 17, 17, 0.5); pointer-events: none; }
        .calendar-week-sum { background: rgba(59, 130, 246, 0.05); display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 8px; border-left: 1px solid var(--border-color); }
        .week-sum-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .week-sum-value { font-family: 'Space Mono', monospace; font-size: 0.85rem; font-weight: 700; }
        .day-number { font-family: 'Space Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }
        .day-profit { text-align: right; font-family: 'Space Mono', monospace; font-weight: 700; font-size: 0.85rem; }
        .day-profit.positive { color: var(--accent-green); }
        .day-profit.negative { color: var(--accent-red); }
        .day-profit.neutral { color: var(--text-muted); }
        .day-trades-count { font-size: 0.65rem; color: var(--text-secondary); text-align: right; margin-top: 4px; }

        /* Monthly Stats Sidebar */
        .month-stat-group { margin-bottom: 24px; }
        .month-stat-group:last-child { margin-bottom: 0; }
        .month-stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-family: 'Space Mono', monospace; }
        .month-stat-value { font-size: 1.5rem; font-weight: 700; font-family: 'Space Mono', monospace; }
        .month-stat-sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; display: flex; justify-content: space-between; }

        /* Filters & Table */
        .filters-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; font-family: 'Instrument Sans', sans-serif; }
        .filter-btn:hover, .filter-btn.active { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }
        .search-box { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 20px; font-size: 0.875rem; width: 280px; font-family: 'Instrument Sans', sans-serif; }
        .search-box:focus { outline: none; border-color: var(--text-secondary); }

        .table-container { background: var(--bg-secondary); border: 1px solid var(--border-color); overflow: hidden; overflow-x: auto; }
        .table-header { display: grid; grid-template-columns: 45px 80px 115px 55px 75px 90px 130px 65px 85px 85px 85px 1fr 65px 90px 55px 75px; gap: 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); padding: 0 20px; min-width: 1650px; }
        .table-header-cell { padding: 16px 0; font-size: 0.6rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Space Mono', monospace; }
        .table-body { max-height: 600px; overflow-y: auto; min-width: 1650px; }
        .table-body::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-body::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .table-body::-webkit-scrollbar-thumb { background: var(--border-color); }
        .table-row { display: grid; grid-template-columns: 45px 80px 115px 55px 75px 90px 130px 65px 85px 85px 85px 1fr 65px 90px 55px 75px; gap: 12px; border-bottom: 1px solid var(--border-color); padding: 0 20px; transition: all 0.2s ease; opacity: 0; transform: translateX(-20px); cursor: pointer; }
        .table-row.loaded { opacity: 1; transform: translateX(0); }
        .table-row:hover { background: var(--bg-tertiary); }
        .table-row.grouped { background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--accent-blue); }
        .table-cell { padding: 12px 0; font-size: 0.75rem; display: flex; align-items: center; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; }
        .cell-no { font-family: 'Space Mono', monospace; color: var(--text-muted); }
        .cell-date { font-family: 'Space Mono', monospace; font-size: 0.7rem; }
        .cell-asset { font-weight: 600; color: var(--text-primary); }
        .cell-type { display: inline-flex; padding: 3px 8px; font-size: 0.65rem; font-weight: 600; letter-spacing: 0.5px; border-radius: 3px; }
        .cell-type.buy { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .cell-type.sell { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .cell-category { font-size: 0.65rem; padding: 3px 8px; border-radius: 3px; background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-price { font-family: 'Space Mono', monospace; font-size: 0.75rem; }
        .cell-strategy { font-size: 0.7rem; color: var(--text-muted); line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cell-setid { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--text-muted); }
        .cell-type-text { font-size: 0.7rem; color: var(--text-secondary); }
        .cell-rr { font-family: 'Instrument Sans', sans-serif; font-weight: 600; font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; letter-spacing: 0; }
        .cell-result { font-weight: 600; font-size: 0.65rem; padding: 3px 8px; border-radius: 3px; }
        .cell-result.tp, .cell-result.tp1, .cell-result.tp2 { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .cell-result.sl { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .cell-result.none, .cell-result.bit { background: rgba(251, 191, 36, 0.15); color: var(--accent-gold); }
        .cell-points { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 0.75rem; }
        .cell-points.positive { color: var(--accent-green); }
        .cell-points.negative { color: var(--accent-red); }
        .cell-status { font-weight: 700; font-size: 0.65rem; letter-spacing: 0.5px; }
        .cell-status.win { color: var(--accent-green); }
        .cell-status.lose { color: var(--accent-red); }
        .cell-status.draw { color: var(--accent-gold); }
        .cell-status.none, .cell-status.cancel, .cell-status.hold { color: var(--text-muted); }
        .group-badge { display: inline-flex; align-items: center; gap: 4px; background: var(--accent-blue); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; font-weight: 600; margin-left: 4px; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 100px 40px; text-align: center; }
        .empty-icon { width: 80px; height: 80px; border: 2px dashed var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; }
        .empty-icon svg { width: 32px; height: 32px; stroke: var(--text-muted); }
        .empty-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 8px; }
        .empty-desc { color: var(--text-muted); font-size: 0.875rem; max-width: 400px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto; transform: translateY(20px); transition: all 0.3s ease; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 32px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; transition: color 0.2s; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 32px; }
        .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .detail-item { display: flex; flex-direction: column; gap: 6px; }
        .detail-item.full { grid-column: 1 / -1; }
        .detail-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-family: 'Space Mono', monospace; }
        .detail-value { font-size: 1rem; color: var(--text-primary); }
        .detail-note { background: var(--bg-tertiary); padding: 16px; font-size: 0.875rem; line-height: 1.6; color: var(--text-secondary); margin-top: 8px; white-space: pre-wrap; }
        .group-entries { margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 24px; }
        .group-entries-title { font-family: 'Space Mono', monospace; font-size: 0.8rem; color: var(--accent-blue); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .group-entry-item { background: var(--bg-tertiary); padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--accent-blue); }
        .group-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .group-entry-round { font-family: 'Space Mono', monospace; font-size: 0.8rem; color: var(--accent-blue); }
        .group-entry-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .group-entry-grid .detail-item { gap: 4px; }
        .group-entry-grid .detail-label { font-size: 0.65rem; }
        .group-entry-grid .detail-value { font-size: 0.9rem; }

        @media (max-width: 1024px) {
            .calendar-section { grid-template-columns: 1fr; }
            .calendar-main { border-right: none; border-bottom: 1px solid var(--border-color); }
            .calendar-sidebar { flex-direction: row; gap: 24px; flex-wrap: wrap; }
            .month-stat-group { margin-bottom: 0; flex: 1; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .header { flex-direction: column; gap: 30px; }
            .performance-section { grid-template-columns: 1fr; }
            .detail-grid { grid-template-columns: repeat(2, 1fr); }
            .calendar-day { min-height: 80px; padding: 4px; }
            .day-profit { font-size: 0.7rem; }
            .calendar-sidebar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <h1>TRADE<span>JOURNEY</span></h1>
                <p>Trading Performance Tracker</p>
            </div>
            <div class="upload-section">
                <button class="btn" onclick="fetchFromGoogleSheet()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    CLOUD SYNC (SHEET)
                </button>

                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                    UPLOAD FILE
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                
                <div class="file-name" id="statusText">Ready to sync</div>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <span class="stat-label">Total Trades</span>
                <span class="stat-value" id="totalTrades">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Win Rate</span>
                <span class="stat-value positive" id="winRate">0%</span>
                <span class="stat-sub" id="winRateSub">0W / 0L / 0D</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Total Points</span>
                <span class="stat-value" id="totalPoints">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Best Trade</span>
                <span class="stat-value positive" id="bestTrade">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Worst Trade</span>
                <span class="stat-value negative" id="worstTrade">0</span>
            </div>
        </div>

        <div class="performance-section" id="performanceSection">
            <div class="chart-container">
                <div class="section-title">Daily Points</div>
                <div class="chart-wrapper">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="section-title">Equity Curve (Cumulative)</div>
                <div class="chart-wrapper">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
            <div class="extended-stats">
                <div class="section-title">Statistics</div>
                <div class="stats-list">
                    <div class="stats-row">
                        <span class="stats-label">Win Streak:</span>
                        <span class="stats-value" id="maxWinStreak">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Lose Streak:</span>
                        <span class="stats-value" id="maxLoseStreak">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Avg Win:</span>
                        <span class="stats-value positive" id="avgWin">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Avg Loss:</span>
                        <span class="stats-value negative" id="avgLoss">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Profit Factor:</span>
                        <span class="stats-value" id="profitFactor">0</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">Expectancy:</span>
                        <span class="stats-value" id="expectancy">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="calendar-section" id="calendarSection">
            <div class="calendar-main">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarTitle">January 2024</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                        </button>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
                    <div class="calendar-day-header weekly-sum">W.Total</div> </div>
                <div class="calendar-grid" id="calendarGrid">
                    </div>
            </div>
            
            <div class="calendar-sidebar">
                <div class="month-stat-group">
                    <div class="month-stat-label">Monthly PnL</div>
                    <div class="month-stat-value positive" id="monthTotalPoints">+0</div>
                    <div class="month-stat-sub">
                        <span>Trades: <span id="monthTotalTrades">0</span></span>
                    </div>
                </div>
                <div class="month-stat-group">
                    <div class="month-stat-label">Win Rate</div>
                    <div class="month-stat-value" id="monthWinRate">0%</div>
                    <div class="month-stat-sub">
                        <span style="color: var(--accent-green)" id="monthWins">0W</span>
                        <span style="color: var(--accent-red)" id="monthLosses">0L</span>
                    </div>
                </div>
                <div class="month-stat-group">
                    <div class="month-stat-label">Performance</div>
                    <div class="month-stat-sub">
                        <span>Avg RR:</span>
                        <span style="font-weight: 600;" id="monthAvgRR">0</span>
                    </div>
                    <div class="month-stat-sub">
                        <span>Avg Win:</span>
                        <span style="color: var(--accent-green);" id="monthAvgWin">0</span>
                    </div>
                    <div class="month-stat-sub">
                        <span>Avg Loss:</span>
                        <span style="color: var(--accent-red);" id="monthAvgLoss">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="filters-section">
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="filterTrades('all', this)">All</button>
                <button class="filter-btn" data-filter="win" onclick="filterTrades('win', this)">Win</button>
                <button class="filter-btn" data-filter="lose" onclick="filterTrades('lose', this)">Lose</button>
                <button class="filter-btn" data-filter="draw" onclick="filterTrades('draw', this)">Draw</button>
                <button class="filter-btn" data-filter="other" onclick="filterTrades('other', this)">Other</button>
                <button class="filter-btn" data-filter="buy" onclick="filterTrades('buy', this)">Buy</button>
                <button class="filter-btn" data-filter="sell" onclick="filterTrades('sell', this)">Sell</button>
            </div>
            <input type="text" class="search-box" placeholder="Search asset, strategy, setup..." id="searchBox" oninput="searchTrades(this.value)">
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-header-cell">No.</div>
                <div class="table-header-cell">SetID</div>
                <div class="table-header-cell">Date</div>
                <div class="table-header-cell">Plan</div>
                <div class="table-header-cell">Type</div>
                <div class="table-header-cell">Asset</div>
                <div class="table-header-cell">Category</div>
                <div class="table-header-cell">Order</div>
                <div class="table-header-cell">Entry</div>
                <div class="table-header-cell">TP</div>
                <div class="table-header-cell">SL</div>
                <div class="table-header-cell">Strategy</div>
                <div class="table-header-cell">Result</div>
                <div class="table-header-cell">Points</div>
                <div class="table-header-cell">RR</div>
                <div class="table-header-cell">Status</div>
            </div>
            <div class="table-body" id="tableBody">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Not Connected</h3>
                    <p class="empty-desc">Click 'Cloud Sync' to load data from Google Sheets</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Trade Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // --- ส่วนที่แก้ไข: ใส่ URL ของ Web App ที่ได้จาก Google Apps Script ตรงนี้ ---
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxqDwgTOq4wD2gLakTSiVUWhKfOwYNxhfk_LMiGwgzjKFmxaQfwMtVSnuvu9N8myb_b/exec'; 
        // -------------------------------------------------------------------

        let tradesData = [];
        let filteredData = [];
        let groupedTrades = {};
        let currentCalendarDate = new Date();
        let dailyProfitData = {};
        let tradesByMonth = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Auto-load if you want, or just wait for button click
            // fetchFromGoogleSheet();
            
            // Existing File Input Listener
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const statusText = document.getElementById('statusText');
                statusText.textContent = 'Reading file...';
                statusText.style.color = 'var(--text-muted)';
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        processData(jsonData);
                        statusText.textContent = 'File Loaded: ' + file.name;
                        statusText.style.color = 'var(--accent-green)';
                    } catch (error) {
                        console.error(error);
                        statusText.textContent = 'Error reading file';
                        statusText.style.color = 'var(--accent-red)';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
            
            renderCalendar();
        });

        // --- New Function: Fetch from Google Sheet ---
        function fetchFromGoogleSheet() {
            const statusText = document.getElementById('statusText');
            statusText.textContent = 'Syncing...';
            statusText.style.color = 'var(--accent-blue)';

            if (SHEET_API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE' || !SHEET_API_URL) {
                alert('Please put your Web App URL in the code variable: SHEET_API_URL');
                statusText.textContent = 'Config Error';
                statusText.style.color = 'var(--accent-red)';
                return;
            }

            fetch(SHEET_API_URL)
                .then(response => response.json())
                .then(data => {
                    // data ที่ได้จะเป็น 2D Array [["Header1", "Header2"], ["Val1", "Val2"]]
                    // ซึ่งเหมือนกับ format ที่ XLSX.utils.sheet_to_json({header:1}) ส่งออกมาพอดี
                    processData(data);
                    statusText.textContent = 'Synced with Cloud';
                    statusText.style.color = 'var(--accent-green)';
                })
                .catch(error => {
                    console.error('Error fetching sheet:', error);
                    statusText.textContent = 'Sync Failed';
                    statusText.style.color = 'var(--accent-red)';
                });
        }
        // ---------------------------------------------

        // ... (Script ส่วนอื่นๆ ตั้งแต่บรรทัด let currentFilter = 'all'; ลงไป เหมือนเดิมทุกประการ) ...
        let currentFilter = 'all';

        function filterTrades(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyFilters(filter, document.getElementById('searchBox').value);
        }

        function searchTrades(searchValue) {
            applyFilters(currentFilter, searchValue);
        }

        function getSetIdBase(setId) {
            if (!setId) return null;
            const str = setId.toString();
            const lastDash = str.lastIndexOf('-');
            if (lastDash > 0) {
                return str.substring(0, lastDash);
            }
            return str;
        }

        function getRoundFromSetId(setId) {
            if (!setId) return 1;
            const str = setId.toString();
            const lastDash = str.lastIndexOf('-');
            if (lastDash > 0 && lastDash < str.length - 1) {
                return parseInt(str.substring(lastDash + 1)) || 1;
            }
            return 1;
        }

        function processData(data) {
            let headerIndex = 0;
            // หา header row
            for (let i = 0; i < data.length; i++) {
                // เช็คให้แน่ใจว่าเป็น Array ก่อนใช้ includes
                if (Array.isArray(data[i]) && (data[i].includes('No.') || data[i].includes('SetID'))) {
                    headerIndex = i;
                    break;
                }
            }

            tradesData = [];
            groupedTrades = {};
            dailyProfitData = {};
            tradesByMonth = {};

            for (let i = headerIndex + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[0]) continue;

                let rrValue = row[15] || '';
                if (rrValue) {
                    rrValue = rrValue.toString().replace(/\s/g, '');
                }

                const trade = {
                    no: row[0] || '',
                    setId: row[1] || '',
                    date: formatDate(row[2]), // ใช้ formatDate ตัวเดิมรองรับทั้ง string/excel date
                    plan: row[3] || '',
                    type: row[4] || '',
                    asset: row[5] || '',
                    category: row[6] || '',
                    order: row[7] || '',
                    entryOrder: row[8] || '',
                    tpOrder: row[9] || '',
                    slOrder: row[10] || '',
                    strategy: row[11] || '',
                    setup: row[12] || '',
                    result: row[13] || '',
                    points: parseFloat(row[14]) || 0,
                    rr: rrValue,
                    notePlan: row[16] || '',
                    status: row[17] || ''
                };

                const setIdBase = getSetIdBase(trade.setId);
                trade.setIdBase = setIdBase;
                trade.round = getRoundFromSetId(trade.setId);

                tradesData.push(trade);

                if (setIdBase) {
                    if (!groupedTrades[setIdBase]) {
                        groupedTrades[setIdBase] = [];
                    }
                    groupedTrades[setIdBase].push(trade);
                }

                // Aggregate daily profit & Monthly Data
                if (trade.date) {
                    if (!dailyProfitData[trade.date]) {
                        dailyProfitData[trade.date] = { points: 0, count: 0 };
                    }
                    dailyProfitData[trade.date].points += trade.points;
                    dailyProfitData[trade.date].count += 1;

                    // Parse Month Key (e.g. "2024-01") for stats
                    // Expecting DD/MM/YYYY
                    const parts = trade.date.split('/');
                    if(parts.length === 3) {
                        const monthKey = `${parts[2]}-${parts[1]}`; // YYYY-MM
                        if (!tradesByMonth[monthKey]) tradesByMonth[monthKey] = [];
                        tradesByMonth[monthKey].push(trade);
                    }
                }
            }

            // Set current calendar date to the last trade date
            if (tradesData.length > 0) {
                const lastTradeDate = tradesData[tradesData.length - 1].date;
                const parts = lastTradeDate.split('/');
                if (parts.length === 3) {
                    currentCalendarDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }

            tradesData.forEach(trade => {
                const group = groupedTrades[trade.setIdBase];
                trade.isGrouped = group && group.length > 1;
                trade.groupSize = group ? group.length : 1;
            });

            filteredData = [...tradesData];
            updateStats();
            updateExtendedStats();
            renderCharts();
            renderTable();
            renderCalendar();
            
            document.getElementById('statsGrid').classList.add('loaded');
            document.getElementById('performanceSection').classList.add('loaded');
            document.getElementById('calendarSection').classList.add('loaded');
        }

        function formatDate(excelDate) {
            if (!excelDate) return '';
            // ถ้า Google Sheet ส่งมาเป็น String เช่น "25/01/2026" อยู่แล้ว ให้ return เลย
            if (typeof excelDate === 'string') return excelDate;
            // กรณีเป็น Excel Serial Date (เผื่อไว้)
            const date = new Date((excelDate - 25569) * 86400 * 1000);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // --- ส่วนที่เหลือ copy ฟังก์ชันเดิมของคุณมาใส่ได้เลยครับ (changeMonth, renderCalendar, updateStats ฯลฯ) ---
        // เนื่องจากโค้ดยาวมาก ผมจึงขอละส่วน logic เดิมไว้ เพื่อให้โฟกัสที่การเชื่อม API ครับ
        // ******************************************************************************************
        // ******************************************************************************************
        // ********* (วางส่วน Logic เดิม: changeMonth จนถึง applyFilters ตรงนี้ครับ)  **************
        // ******************************************************************************************
        
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }
        
        // ... (วางโค้ด JS ส่วนที่เหลือต่อท้ายที่นี่) ...
        
        // ... Copy function renderCalendar() ...
        // ... Copy function renderWeekSum() ...
        // ... Copy function renderMonthlyStats() ...
        // ... Copy function updateStats() ...
        // ... Copy function updateExtendedStats() ...
        // ... Copy function renderCharts() ...
        // ... Copy function renderDailyChart() ...
        // ... Copy function renderEquityChart() ...
        // ... Copy function renderTable() ...
        // ... Copy function getResultClass() ...
        // ... Copy function getStatusClass() ...
        // ... Copy function truncate() ...
        // ... Copy function openModal() ...
        // ... Copy function closeModal() ...
        // ... Copy function applyFilters() ...

    </script>
</body>
</html>
