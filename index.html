<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journey</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --border-color: #2a2a2a;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-gold: #fbbf24;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Instrument Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container { max-width: 1800px; margin: 0 auto; padding: 40px 20px; }

        /* Header Layout */
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 20px; }
        
        .logo-section { display: flex; flex-direction: column; justify-content: center; }
        .main-logo { max-height: 150px; width: 150; display: block; margin-bottom: 8px; }
        .logo-section p { font-size: 0.875rem; color: var(--text-secondary); font-family: 'Space Mono', monospace; }
        
        .controls-wrapper { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        /* Dropdown Style */
        .custom-select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0 16px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
            min-width: 180px;
            height: 42px; /* Match button height */
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }
        .custom-select:hover { border-color: var(--text-secondary); }

        .btn { background: var(--text-primary); color: var(--bg-primary); border: none; padding: 0 24px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; font-family: 'Instrument Sans', sans-serif; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; height: 42px; }
        .btn:hover { background: var(--text-secondary); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { border-color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .file-input { display: none; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; background: var(--border-color); margin-bottom: 40px; opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
        .stats-grid.loaded { opacity: 1; transform: translateY(0); }
        .stat-card { background: var(--bg-secondary); padding: 24px; display: flex; flex-direction: column; gap: 6px; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-family: 'Space Mono', monospace; }
        .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Space Mono', monospace; letter-spacing: -1px; }
        .stat-value.positive { color: var(--accent-green); }
        .stat-value.negative { color: var(--accent-red); }
        .stat-sub { font-size: 0.8rem; color: var(--text-secondary); }

        /* Performance Section */
        .performance-section { display: grid; grid-template-columns: 1fr 1fr 280px; gap: 1px; background: var(--border-color); margin-bottom: 40px; opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
        .performance-section.loaded { opacity: 1; transform: translateY(0); }
        .chart-container { background: var(--bg-secondary); padding: 24px; position: relative; }
        .extended-stats { background: var(--bg-secondary); padding: 24px; }
        
        .section-title { 
            font-family: 'Space Mono', monospace; 
            font-size: 0.7rem; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            margin-bottom: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        /* Filter Chip (Power BI Interaction) */
        .active-filter-chip { 
            display: none; 
            align-items: center; 
            gap: 6px; 
            background: rgba(34, 197, 94, 0.1); 
            color: var(--accent-green); 
            padding: 4px 10px; 
            border-radius: 4px; 
            font-size: 0.65rem; 
            font-weight: 600; 
            cursor: pointer;
            border: 1px solid rgba(34, 197, 94, 0.3);
            text-transform: none;
            letter-spacing: 0;
        }
        .active-filter-chip:hover { background: rgba(34, 197, 94, 0.2); }
        .active-filter-chip.show { display: inline-flex; }

        .chart-wrapper { height: 240px; position: relative; width: 100%; }
        .stats-list { display: flex; flex-direction: column; gap: 12px; }
        .stats-row { display: flex; justify-content: space-between; align-items: center; }
        .stats-label { font-size: 0.8rem; color: var(--text-secondary); }
        .stats-value { font-family: 'Space Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
        .stats-value.positive { color: var(--accent-green); }
        .stats-value.negative { color: var(--accent-red); }

        /* Calendar Section */
        .calendar-section { background: var(--bg-secondary); border: 1px solid var(--border-color); margin-bottom: 40px; opacity: 0; transform: translateY(10px); transition: all 0.5s ease; display: grid; grid-template-columns: 1fr; } 
        .calendar-section.loaded { opacity: 1; transform: translateY(0); }
        .calendar-main { padding: 24px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-title { font-family: 'Space Mono', monospace; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; }
        .calendar-nav { display: flex; gap: 8px; }
        .calendar-nav-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
        .calendar-nav-btn:hover { border-color: var(--text-primary); color: var(--text-primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); }
        .calendar-day-header { background: var(--bg-tertiary); padding: 12px 4px; text-align: center; font-size: 0.7rem; color: var(--text-muted); font-family: 'Space Mono', monospace; text-transform: uppercase; }
        .calendar-day { background: var(--bg-secondary); min-height: 90px; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; transition: background 0.2s; position: relative; }
        .calendar-day:hover { background: var(--bg-tertiary); }
        .calendar-day.empty { background: rgba(17, 17, 17, 0.5); pointer-events: none; }
        .day-number { font-family: 'Space Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }
        .day-profit { text-align: right; font-family: 'Space Mono', monospace; font-weight: 700; font-size: 0.8rem; }
        .day-profit.positive { color: var(--accent-green); }
        .day-profit.negative { color: var(--accent-red); }
        .day-profit.neutral { color: var(--text-muted); }
        .day-trades-count { font-size: 0.65rem; color: var(--text-secondary); text-align: right; margin-top: 4px; }

        /* Filters & Table */
        .filters-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .filter-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 16px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease; font-family: 'Instrument Sans', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-btn:hover, .filter-btn.active { background: var(--text-primary); color: var(--bg-primary); border-color: var(--text-primary); }
        .search-box { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; font-size: 0.8rem; width: 260px; font-family: 'Instrument Sans', sans-serif; }
        .search-box:focus { outline: none; border-color: var(--text-secondary); }

        .table-container { background: var(--bg-secondary); border: 1px solid var(--border-color); overflow: hidden; overflow-x: auto; }
        .table-header { display: grid; grid-template-columns: 45px 80px 115px 55px 75px 90px 130px 65px 85px 85px 85px 1fr 65px 90px 55px 75px; gap: 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); padding: 0 20px; min-width: 1650px; }
        .table-header-cell { padding: 16px 0; font-size: 0.6rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-family: 'Space Mono', monospace; }
        .table-body { max-height: 600px; overflow-y: auto; min-width: 1650px; }
        .table-body::-webkit-scrollbar { width: 6px; height: 6px; }
        .table-body::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .table-body::-webkit-scrollbar-thumb { background: var(--border-color); }
        .table-row { display: grid; grid-template-columns: 45px 80px 115px 55px 75px 90px 130px 65px 85px 85px 85px 1fr 65px 90px 55px 75px; gap: 12px; border-bottom: 1px solid var(--border-color); padding: 0 20px; transition: all 0.2s ease; opacity: 0; transform: translateX(-10px); cursor: pointer; }
        .table-row.loaded { opacity: 1; transform: translateX(0); }
        .table-row:hover { background: var(--bg-tertiary); }
        .table-row.grouped { background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--accent-blue); }
        .table-cell { padding: 12px 0; font-size: 0.75rem; display: flex; align-items: center; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; }
        .cell-no { font-family: 'Space Mono', monospace; color: var(--text-muted); }
        .cell-date { font-family: 'Space Mono', monospace; font-size: 0.7rem; }
        .cell-asset { font-weight: 600; color: var(--text-primary); }
        .cell-type { display: inline-flex; padding: 3px 8px; font-size: 0.65rem; font-weight: 600; letter-spacing: 0.5px; border-radius: 3px; }
        .cell-type.buy { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .cell-type.sell { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .cell-category { font-size: 0.65rem; padding: 3px 8px; border-radius: 3px; background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-price { font-family: 'Space Mono', monospace; font-size: 0.75rem; }
        .cell-strategy { font-size: 0.7rem; color: var(--text-muted); line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cell-setid { font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--text-muted); }
        .cell-type-text { font-size: 0.7rem; color: var(--text-secondary); }
        .cell-rr { font-family: 'Instrument Sans', sans-serif; font-weight: 600; font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; letter-spacing: 0; }
        .cell-result { font-weight: 600; font-size: 0.65rem; padding: 3px 8px; border-radius: 3px; }
        .cell-result.tp, .cell-result.tp1, .cell-result.tp2 { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .cell-result.sl { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .cell-result.none, .cell-result.bit { background: rgba(251, 191, 36, 0.15); color: var(--accent-gold); }
        .cell-points { font-family: 'Space Mono', monospace; font-weight: 600; font-size: 0.75rem; }
        .cell-points.positive { color: var(--accent-green); }
        .cell-points.negative { color: var(--accent-red); }
        .cell-status { font-weight: 700; font-size: 0.65rem; letter-spacing: 0.5px; }
        .cell-status.win { color: var(--accent-green); }
        .cell-status.lose { color: var(--accent-red); }
        .cell-status.draw { color: var(--accent-gold); }
        .cell-status.none, .cell-status.cancel, .cell-status.hold { color: var(--text-muted); }
        .group-badge { display: inline-flex; align-items: center; gap: 4px; background: var(--accent-blue); color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; font-weight: 600; margin-left: 4px; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 40px; text-align: center; }
        .empty-icon { width: 64px; height: 64px; border: 2px dashed var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
        .empty-icon svg { width: 24px; height: 24px; stroke: var(--text-muted); }
        .empty-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
        .empty-desc { color: var(--text-muted); font-size: 0.8rem; max-width: 400px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto; transform: translateY(20px); transition: all 0.3s ease; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px 32px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; transition: color 0.2s; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 32px; }
        .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .detail-item { display: flex; flex-direction: column; gap: 6px; }
        .detail-item.full { grid-column: 1 / -1; }
        .detail-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-family: 'Space Mono', monospace; }
        .detail-value { font-size: 1rem; color: var(--text-primary); }
        .detail-note { background: var(--bg-tertiary); padding: 16px; font-size: 0.875rem; line-height: 1.6; color: var(--text-secondary); margin-top: 8px; white-space: pre-wrap; }
        .group-entries { margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 24px; }
        .group-entries-title { font-family: 'Space Mono', monospace; font-size: 0.8rem; color: var(--accent-blue); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .group-entry-item { background: var(--bg-tertiary); padding: 16px; margin-bottom: 12px; border-left: 3px solid var(--accent-blue); }
        .group-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .group-entry-round { font-family: 'Space Mono', monospace; font-size: 0.8rem; color: var(--accent-blue); }
        .group-entry-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .group-entry-grid .detail-item { gap: 4px; }
        .group-entry-grid .detail-label { font-size: 0.65rem; }
        .group-entry-grid .detail-value { font-size: 0.9rem; }

        @media (max-width: 1024px) {
            .calendar-section { grid-template-columns: 1fr; }
            .calendar-main { border-right: none; border-bottom: 1px solid var(--border-color); }
            .calendar-sidebar { flex-direction: row; gap: 24px; flex-wrap: wrap; }
            .month-stat-group { margin-bottom: 0; flex: 1; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .header { flex-direction: column; gap: 30px; }
            .performance-section { grid-template-columns: 1fr; }
            .detail-grid { grid-template-columns: repeat(2, 1fr); }
            .calendar-day { min-height: 80px; padding: 4px; }
            .day-profit { font-size: 0.7rem; }
            .calendar-sidebar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <img src="logo.png" class="main-logo" alt="Trade Journey Logo">
                <p>Trading Performance Tracker</p>
            </div>
            
            <div class="controls-wrapper">
                <select id="monthSelector" class="custom-select" onchange="filterByMonth(this.value)">
                    <option value="all">All Time</option>
                </select>

                <button class="btn" onclick="fetchFromGoogleSheet()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    CLOUD SYNC
                </button>

                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                    UPLOAD FILE
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
            </div>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><span class="stat-label">Total Trades</span><span class="stat-value" id="totalTrades">0</span></div>
            <div class="stat-card"><span class="stat-label">Win Rate</span><span class="stat-value positive" id="winRate">0%</span><span class="stat-sub" id="winRateSub">0W / 0L / 0D</span></div>
            <div class="stat-card"><span class="stat-label">Total Points</span><span class="stat-value" id="totalPoints">0</span></div>
            <div class="stat-card"><span class="stat-label">Best Trade</span><span class="stat-value positive" id="bestTrade">0</span></div>
            <div class="stat-card"><span class="stat-label">Worst Trade</span><span class="stat-value negative" id="worstTrade">0</span></div>
        </div>

        <div class="performance-section" id="performanceSection">
            <div class="chart-container">
                <div class="section-title">
                    Daily Points
                    <div id="chartFilterTag" class="active-filter-chip" onclick="clearChartFilter()">
                        <span id="chartFilterText">Date</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </div>
                </div>
                <div class="chart-wrapper"><canvas id="dailyChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="section-title">Equity Curve (Cumulative)</div>
                <div class="chart-wrapper"><canvas id="equityChart"></canvas></div>
            </div>
            <div class="extended-stats">
                <div class="section-title">Statistics</div>
                <div class="stats-list">
                    <div class="stats-row"><span class="stats-label">Win Streak:</span><span class="stats-value" id="maxWinStreak">0</span></div>
                    <div class="stats-row"><span class="stats-label">Lose Streak:</span><span class="stats-value" id="maxLoseStreak">0</span></div>
                    <div class="stats-row"><span class="stats-label">Avg Win:</span><span class="stats-value positive" id="avgWin">0</span></div>
                    <div class="stats-row"><span class="stats-label">Avg Loss:</span><span class="stats-value negative" id="avgLoss">0</span></div>
                    <div class="stats-row"><span class="stats-label">Profit Factor:</span><span class="stats-value" id="profitFactor">0</span></div>
                    <div class="stats-row"><span class="stats-label">Expectancy:</span><span class="stats-value" id="expectancy">0</span></div>
                </div>
            </div>
        </div>

        <div class="calendar-section" id="calendarSection">
            <div class="calendar-main">
                <div class="calendar-header">
                    <div class="calendar-title" id="calendarTitle">Calendar</div>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></button>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div><div class="calendar-day-header">Mon</div><div class="calendar-day-header">Tue</div><div class="calendar-day-header">Wed</div><div class="calendar-day-header">Thu</div><div class="calendar-day-header">Fri</div><div class="calendar-day-header">Sat</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div class="filters-section">
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="filterTrades('all', this)">All</button>
                <button class="filter-btn" data-filter="win" onclick="filterTrades('win', this)">Win</button>
                <button class="filter-btn" data-filter="lose" onclick="filterTrades('lose', this)">Lose</button>
                <button class="filter-btn" data-filter="draw" onclick="filterTrades('draw', this)">Draw</button>
                <button class="filter-btn" data-filter="other" onclick="filterTrades('other', this)">Other</button>
                <button class="filter-btn" data-filter="buy" onclick="filterTrades('buy', this)">Buy</button>
                <button class="filter-btn" data-filter="sell" onclick="filterTrades('sell', this)">Sell</button>
            </div>
            <input type="text" class="search-box" placeholder="Search asset, strategy..." id="searchBox" oninput="searchTrades(this.value)">
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-header-cell">No.</div><div class="table-header-cell">SetID</div><div class="table-header-cell">Date</div><div class="table-header-cell">Plan</div><div class="table-header-cell">Type</div><div class="table-header-cell">Asset</div><div class="table-header-cell">Category</div><div class="table-header-cell">Order</div><div class="table-header-cell">Entry</div><div class="table-header-cell">TP</div><div class="table-header-cell">SL</div><div class="table-header-cell">Strategy</div><div class="table-header-cell">Result</div><div class="table-header-cell">Points</div><div class="table-header-cell">RR</div><div class="table-header-cell">Status</div>
            </div>
            <div class="table-body" id="tableBody">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 0 1-2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z"/></svg></div>
                    <h3 class="empty-title">Not Connected</h3>
                    <p class="empty-desc">Click 'Cloud Sync' to load data</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Trade Details</h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzHvKwXDeBbZbcJlXDim-kCZ1-Fjujo7EAGoc_Z3Evo_VITa1PqqfnnebBAxMAsUPMA/exec'; 

        // State variables
        let allTrades = [];      // Raw Data from Sheet
        let displayedTrades = []; // Data currently shown
        let groupedTrades = {};
        
        // Active Filter State
        let activeFilters = {
            status: 'all',
            search: '',
            month: 'all',
            specificDate: null // For Chart Click Interaction
        };

        // Charts & Calendars
        let dailyChart = null;
        let equityChart = null;
        let currentCalendarDate = new Date();
        let dailyProfitData = {};

        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
            document.getElementById('modalOverlay').addEventListener('click', (e) => { if(e.target === document.getElementById('modalOverlay')) closeModal(); });
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        });

        // --- Data Loading ---
        function fetchFromGoogleSheet() {
            const btn = document.querySelector('.btn'); // Button indicator
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span style="font-size:16px">↻</span> Syncing...';
            
            fetch(SHEET_API_URL)
                .then(res => res.json())
                .then(data => {
                    processData(data);
                    btn.innerHTML = originalText;
                })
                .catch(err => {
                    console.error(err);
                    btn.innerHTML = originalText;
                    alert('Sync Failed. Please check permissions.');
                });
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                processData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            let headerIndex = 0;
            for (let i = 0; i < data.length; i++) {
                if (Array.isArray(data[i]) && (data[i].includes('No.') || data[i].includes('SetID'))) {
                    headerIndex = i; break;
                }
            }

            allTrades = [];
            groupedTrades = {};
            
            for (let i = headerIndex + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[0]) continue;

                let rrValue = row[15] ? row[15].toString().replace(/\s/g, '') : '';
                
                const trade = {
                    no: row[0] || '', setId: row[1] || '', date: formatDate(row[2]),
                    plan: row[3] || '', type: row[4] || '', asset: row[5] || '',
                    category: row[6] || '', order: row[7] || '', entryOrder: row[8] || '',
                    tpOrder: row[9] || '', slOrder: row[10] || '', strategy: row[11] || '',
                    setup: row[12] || '', result: row[13] || '', points: parseFloat(row[14]) || 0,
                    rr: rrValue, notePlan: row[16] || '', status: row[17] || ''
                };

                const setIdBase = getSetIdBase(trade.setId);
                trade.setIdBase = setIdBase;
                trade.round = getRoundFromSetId(trade.setId);
                
                allTrades.push(trade);

                if (setIdBase) {
                    if (!groupedTrades[setIdBase]) groupedTrades[setIdBase] = [];
                    groupedTrades[setIdBase].push(trade);
                }
            }

            allTrades.forEach(trade => {
                const group = groupedTrades[trade.setIdBase];
                trade.isGrouped = group && group.length > 1;
                trade.groupSize = group ? group.length : 1;
            });

            // Set Calendar to latest date
            if (allTrades.length > 0) {
                const lastDate = parseDateString(allTrades[allTrades.length - 1].date);
                if (lastDate) currentCalendarDate = lastDate;
            }

            populateMonthDropdown();
            applyAllFilters(); 
            
            document.querySelector('.stats-grid').classList.add('loaded');
            document.querySelector('.performance-section').classList.add('loaded');
            document.querySelector('.calendar-section').classList.add('loaded');
        }

        // --- Core Logic: The "Brain" of Power BI ---
        function applyAllFilters() {
            // 1. First, Filter for Charts (Context) - excludes specific day click
            // So the chart doesn't disappear when you click it
            const contextTrades = allTrades.filter(trade => {
                return checkCommonFilters(trade);
            });

            // 2. Filter for Table & Stats - includes specific day click
            displayedTrades = contextTrades.filter(trade => {
                if (activeFilters.specificDate) {
                    if (trade.date !== activeFilters.specificDate) return false;
                }
                return true;
            });

            // Update UI
            updateStats(displayedTrades);
            updateExtendedStats(displayedTrades);
            renderTable(displayedTrades);
            
            // Charts always show the "Context" (Month/All), but highlight selection if possible
            // For now, let's render the context to keep it user friendly
            renderCharts(contextTrades);
            
            // Calendar shows context
            renderCalendarWithData(contextTrades);
        }

        function checkCommonFilters(trade) {
            // Month Filter
            if (activeFilters.month !== 'all') {
                const tradeDate = parseDateString(trade.date);
                if (!tradeDate) return false;
                const tradeMonthKey = `${tradeDate.getFullYear()}-${tradeDate.getMonth()}`; 
                if (tradeMonthKey !== activeFilters.month) return false;
            }

            // Status/Type Filter
            const status = (trade.status || '').toUpperCase();
            const order = (trade.order || '').toUpperCase();
            let matchStatus = true;
            if (activeFilters.status === 'win') matchStatus = status === 'WIN';
            else if (activeFilters.status === 'lose') matchStatus = status === 'LOSE';
            else if (activeFilters.status === 'draw') matchStatus = status === 'DRAW';
            else if (activeFilters.status === 'other') matchStatus = ['NONE','CANCEL','HOLD',''].includes(status);
            else if (activeFilters.status === 'buy') matchStatus = order === 'BUY';
            else if (activeFilters.status === 'sell') matchStatus = order === 'SELL';
            if (!matchStatus) return false;

            // Search Text
            if (activeFilters.search) {
                const s = activeFilters.search.toLowerCase();
                const matchSearch = (trade.asset.toLowerCase().includes(s) || 
                                   trade.strategy.toLowerCase().includes(s) || 
                                   trade.setup.toLowerCase().includes(s));
                if (!matchSearch) return false;
            }
            return true;
        }

        // --- Input Handlers ---
        function filterTrades(type, btn) {
            activeFilters.status = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyAllFilters();
        }

        function searchTrades(val) {
            activeFilters.search = val;
            applyAllFilters();
        }

        function filterByMonth(val) {
            activeFilters.month = val;
            activeFilters.specificDate = null; // Reset drill-down
            updateChartFilterUI();
            applyAllFilters();
        }

        // --- Chart Click Interaction ---
        function handleChartClick(event, elements, chart) {
            if (!elements || elements.length === 0) return;
            const index = elements[0].index;
            const label = chart.data.labels[index]; // e.g. "25/01/2026" or "25/01"
            
            // Map label back to date string
            // Our chart labels might be simplified. Let's assume they are unique enough.
            // If chart labels are "DD/MM", we need to reconstruct full date using current year/month context?
            // To be safe, let's use the raw data index if possible, but data is aggregated.
            
            // Better approach: The chart label IS the date string key from dailyPoints
            activeFilters.specificDate = label;
            updateChartFilterUI();
            applyAllFilters();
        }

        function clearChartFilter() {
            activeFilters.specificDate = null;
            updateChartFilterUI();
            applyAllFilters();
        }

        function updateChartFilterUI() {
            const chip = document.getElementById('chartFilterTag');
            const text = document.getElementById('chartFilterText');
            if (activeFilters.specificDate) {
                chip.classList.add('show');
                text.textContent = `Filtered: ${activeFilters.specificDate}`;
            } else {
                chip.classList.remove('show');
            }
        }

        // --- Logic Helpers ---
        function populateMonthDropdown() {
            const selector = document.getElementById('monthSelector');
            selector.innerHTML = '<option value="all">All Time</option>';
            const months = new Set();
            allTrades.forEach(t => {
                if(!t.date) return;
                const d = parseDateString(t.date);
                if(d) months.add(`${d.getFullYear()}-${d.getMonth()}`);
            });
            const sortedMonths = Array.from(months).sort((a,b) => {
                const [y1, m1] = a.split('-').map(Number);
                const [y2, m2] = b.split('-').map(Number);
                return (y2 - y1) || (m2 - m1);
            });
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            sortedMonths.forEach(key => {
                const [y, m] = key.split('-');
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = `${monthNames[parseInt(m)]} ${y}`;
                selector.appendChild(opt);
            });
        }

        // --- Render Functions ---
        function updateStats(data) {
            const wins = data.filter(t => (t.status || '').toUpperCase() === 'WIN').length;
            const loses = data.filter(t => (t.status || '').toUpperCase() === 'LOSE').length;
            const draws = data.filter(t => (t.status || '').toUpperCase() === 'DRAW').length;
            const totalPoints = data.reduce((sum, t) => sum + (t.points || 0), 0);
            
            const pointsArr = data.map(t => t.points).filter(p => p !== 0);
            const best = pointsArr.length ? Math.max(...pointsArr) : 0;
            const worst = pointsArr.length ? Math.min(...pointsArr) : 0;
            
            const total = data.length;
            const valid = wins + loses + draws;
            const rate = valid > 0 ? ((wins / valid) * 100).toFixed(1) : 0;

            document.getElementById('totalTrades').textContent = total;
            document.getElementById('winRate').textContent = rate + '%';
            document.getElementById('winRateSub').textContent = `${wins}W / ${loses}L / ${draws}D`;
            document.getElementById('totalPoints').textContent = (totalPoints > 0 ? '+' : '') + totalPoints.toLocaleString();
            document.getElementById('totalPoints').className = `stat-value ${totalPoints >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('bestTrade').textContent = '+' + best.toLocaleString();
            document.getElementById('worstTrade').textContent = worst.toLocaleString();
        }

        function updateExtendedStats(data) {
            let maxWin = 0, maxLose = 0, curWin = 0, curLose = 0;
            let sumWin = 0, countWin = 0, sumLose = 0, countLose = 0;
            
            data.forEach(t => {
                const s = (t.status || '').toUpperCase();
                const p = t.points || 0;
                if(s==='WIN') { curWin++; curLose=0; maxWin=Math.max(maxWin, curWin); sumWin+=p; countWin++; }
                else if(s==='LOSE') { curLose++; curWin=0; maxLose=Math.max(maxLose, curLose); sumLose+=p; countLose++; }
                else { curWin=0; curLose=0; }
            });

            const avgWin = countWin ? Math.round(sumWin/countWin) : 0;
            const avgLoss = countLose ? Math.round(sumLose/countLose) : 0;
            const absLoss = Math.abs(sumLose);
            const pf = absLoss > 0 ? (sumWin / absLoss).toFixed(2) : (sumWin > 0 ? '∞' : '0');
            
            // Expectancy
            const totalWL = countWin + countLose;
            let exp = 0;
            if(totalWL > 0) {
                const winR = countWin/totalWL;
                const lossR = countLose/totalWL;
                exp = (winR * avgWin) + (lossR * avgLoss);
            }

            document.getElementById('maxWinStreak').textContent = maxWin;
            document.getElementById('maxLoseStreak').textContent = maxLose;
            document.getElementById('avgWin').textContent = '+' + avgWin.toLocaleString();
            document.getElementById('avgLoss').textContent = avgLoss.toLocaleString();
            document.getElementById('profitFactor').textContent = pf;
            document.getElementById('expectancy').textContent = (exp>0?'+':'') + Math.round(exp).toLocaleString();
            document.getElementById('expectancy').className = `stats-value ${exp>=0?'positive':'negative'}`;
        }

        function renderCharts(data) {
            // Aggregate daily points
            const dailyMap = {};
            data.forEach(t => {
                if(!t.date) return;
                dailyMap[t.date] = (dailyMap[t.date] || 0) + t.points;
            });

            // Sort dates
            const sortedDates = Object.keys(dailyMap).sort((a,b) => parseDateString(a) - parseDateString(b));
            const dailyValues = sortedDates.map(d => dailyMap[d]);
            
            // Equity
            const equityValues = [];
            let sum = 0;
            equityValues.push(0); // Start at 0
            dailyValues.forEach(v => { sum += v; equityValues.push(sum); });
            const equityLabels = ['Start', ...sortedDates];

            // Render Daily Chart
            const ctxD = document.getElementById('dailyChart');
            if(dailyChart) dailyChart.destroy();
            dailyChart = new Chart(ctxD, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        data: dailyValues,
                        backgroundColor: dailyValues.map(v => v>=0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, el) => handleChartClick(e, el, dailyChart),
                    plugins: { legend: {display:false} },
                    scales: { 
                        x: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: {color:'#666', font:{family:'Space Mono', size:9}} },
                        y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: {color:'#666', font:{family:'Space Mono', size:10}} }
                    }
                }
            });

            // Render Equity Chart
            const ctxE = document.getElementById('equityChart');
            if(equityChart) equityChart.destroy();
            const lastEq = equityValues[equityValues.length-1];
            const eqColor = lastEq >= 0 ? '#22c55e' : '#ef4444';
            const gradient = ctxE.getContext('2d').createLinearGradient(0,0,0,200);
            gradient.addColorStop(0, lastEq>=0?'rgba(34,197,94,0.3)':'rgba(239,68,68,0.3)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');

            equityChart = new Chart(ctxE, {
                type: 'line',
                data: {
                    labels: equityLabels,
                    datasets: [{
                        data: equityValues,
                        borderColor: eqColor,
                        backgroundColor: gradient,
                        borderWidth: 2, fill: true, pointRadius: 2, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display:false} },
                    scales: { 
                        x: { display:false }, 
                        y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: {color:'#666', font:{family:'Space Mono'}} }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            if(data.length === 0) {
                tbody.innerHTML = `<div class="empty-state"><div class="empty-title">No trades found</div></div>`;
                return;
            }
            
            const shownSets = new Set();
            data.forEach(t => {
                if(t.isGrouped) {
                    if(shownSets.has(t.setIdBase)) return;
                    shownSets.add(t.setIdBase);
                }
                const row = document.createElement('div');
                row.className = `table-row ${t.isGrouped?'grouped':''}`;
                row.onclick = () => openModal(t);
                
                let pts = t.points;
                if(t.isGrouped) {
                    const g = groupedTrades[t.setIdBase];
                    if(g) pts = g.reduce((s,x)=>s+(x.points||0),0);
                }
                
                const pClass = pts >= 0 ? 'positive' : 'negative';
                const sClass = getStatusClass(t.status);
                const rClass = getResultClass(t.result);
                const orderClass = (t.order||'').toLowerCase();

                row.innerHTML = `
                    <div class="table-cell cell-no">${t.no}${t.isGrouped?`<span class="group-badge">${t.groupSize}</span>`:''}</div>
                    <div class="table-cell cell-setid">${t.setId}</div>
                    <div class="table-cell cell-date">${t.date}</div>
                    <div class="table-cell">${t.plan}</div>
                    <div class="table-cell cell-type-text">${t.type}</div>
                    <div class="table-cell cell-asset">${t.asset}</div>
                    <div class="table-cell"><span class="cell-category">${t.category}</span></div>
                    <div class="table-cell"><span class="cell-type ${orderClass}">${t.order}</span></div>
                    <div class="table-cell cell-price">${t.entryOrder}</div>
                    <div class="table-cell cell-price">${t.tpOrder}</div>
                    <div class="table-cell cell-price">${t.slOrder}</div>
                    <div class="table-cell cell-strategy">${truncate(t.strategy, 20)}</div>
                    <div class="table-cell"><span class="cell-result ${rClass}">${t.result}</span></div>
                    <div class="table-cell cell-points ${pClass}">${pts>0?'+':''}${pts.toLocaleString()}</div>
                    <div class="table-cell cell-rr">${t.rr}</div>
                    <div class="table-cell cell-status ${sClass}">${t.status}</div>
                `;
                tbody.appendChild(row);
                setTimeout(()=>row.classList.add('loaded'), 10);
            });
        }

        // --- Calendar Logic ---
        function renderCalendarWithData(data) {
            // Aggregate data for calendar
            dailyProfitData = {};
            data.forEach(t => {
                if(t.date) {
                    if(!dailyProfitData[t.date]) dailyProfitData[t.date] = { points:0, count:0 };
                    dailyProfitData[t.date].points += t.points;
                    dailyProfitData[t.date].count++;
                }
            });
            renderCalendar();
        }

        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendarTitle').textContent = `${months[month]} ${year}`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            for(let i=0; i<firstDay; i++) {
                grid.innerHTML += `<div class="calendar-day empty"></div>`;
            }
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${d.toString().padStart(2,'0')}/${(month+1).toString().padStart(2,'0')}/${year}`;
                const info = dailyProfitData[dateStr];
                
                let content = `<div class="day-profit neutral">-</div>`;
                if(info) {
                    const pClass = info.points >= 0 ? 'positive' : 'negative';
                    content = `
                        <div class="day-profit ${pClass}">${info.points>0?'+':''}${info.points.toLocaleString()}</div>
                        <div class="day-trades-count">${info.count} Trades</div>
                    `;
                }
                
                grid.innerHTML += `
                    <div class="calendar-day">
                        <div class="day-number">${d}</div>
                        ${content}
                    </div>
                `;
            }
        }

        // --- Helpers ---
        function getSetIdBase(id) {
            if(!id) return null;
            const str = id.toString();
            const idx = str.lastIndexOf('-');
            return idx > 0 ? str.substring(0, idx) : str;
        }
        function getRoundFromSetId(id) {
            if(!id) return 1;
            const str = id.toString();
            const idx = str.lastIndexOf('-');
            return (idx > 0 && idx < str.length-1) ? parseInt(str.substring(idx+1)) : 1;
        }
        function parseDateString(str) {
            if(!str) return null;
            // Expect DD/MM/YYYY
            const parts = str.split('/');
            if(parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]);
            return null;
        }
        function formatDate(excelDate) {
            if (!excelDate) return '';
            if (typeof excelDate === 'string') return excelDate;
            const date = new Date((excelDate - 25569) * 86400 * 1000);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        function getResultClass(r) { 
            if(!r) return ''; r=r.toString().toUpperCase(); 
            if(r.includes('TP')) return 'tp'; if(r==='SL') return 'sl'; return 'none'; 
        }
        function getStatusClass(s) {
            if(!s) return ''; s=s.toString().toUpperCase();
            if(s==='WIN') return 'win'; if(s==='LOSE') return 'lose'; if(s==='DRAW') return 'draw'; return 'none';
        }
        function truncate(s, l) { if(!s) return '-'; return s.length>l ? s.substring(0,l)+'...' : s; }

        function openModal(t) {
            const modal = document.getElementById('modalOverlay');
            const body = document.getElementById('modalBody');
            
            let groupHTML = '';
            if(t.isGrouped) {
                const g = groupedTrades[t.setIdBase];
                groupHTML = `<div class="group-entries"><div class="group-entries-title">Grouped Entries (${g.length})</div>` + 
                g.map(sub => `
                    <div class="group-entry-item">
                        <div class="group-entry-header"><span class="group-entry-round">${sub.setId}</span><span class="cell-status ${getStatusClass(sub.status)}">${sub.status}</span></div>
                        <div class="group-entry-grid">
                            <div class="detail-item"><span class="detail-label">Entry</span><span class="detail-value">${sub.entryOrder}</span></div>
                            <div class="detail-item"><span class="detail-label">Points</span><span class="detail-value ${sub.points>=0?'positive':'negative'}">${sub.points}</span></div>
                        </div>
                    </div>
                `).join('') + `</div>`;
            }

            body.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item"><span class="detail-label">Asset</span><span class="detail-value">${t.asset}</span></div>
                    <div class="detail-item"><span class="detail-label">Strategy</span><span class="detail-value">${t.strategy}</span></div>
                    <div class="detail-item"><span class="detail-label">Points</span><span class="detail-value ${t.points>=0?'positive':'negative'}">${t.points}</span></div>
                    <div class="detail-item full"><span class="detail-label">Note</span><div class="detail-note">${t.notePlan || '-'}</div></div>
                </div>
                ${groupHTML}
            `;
            modal.classList.add('active');
        }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
    </script>
</body>
</html>
